<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amor e Cacau | Pedidos</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --cor-vinho: #800020;
            --rosa-principal: #ff85a2;
            --marrom-chocolate: #4b2e2e;
            --bege-logo: #f7ede2;
            --verde-wpp: #25d366;
            --cinza-inativo: #ccc;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bege-logo);
            color: var(--marrom-chocolate);
            margin: 0;
            padding: 15px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        header { text-align: center; margin-bottom: 20px; }
        header h1 { color: var(--cor-vinho); margin: 0; }
        .subtitulo { color: var(--rosa-principal); font-weight: bold; font-size: 0.9rem; }

        /* NAVEGA√á√ÉO */
        .tabs-nav { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { flex: none; padding: 10px 15px; border: none; background: #eee; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .tab-btn.active { background: var(--cor-vinho); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* SISTEMA DE SLOTS (ORIGINAL) */
        .box-display { background: #fffafa; padding: 15px; border-radius: 15px; margin-bottom: 20px; text-align: center; border: 1px solid #f0e0e0; }
        .slots-container { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .slot {
            width: 60px; height: 60px; border: 2px dashed var(--cor-vinho); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 0.65rem;
            background: white; cursor: pointer; transition: 0.2s; text-align: center; padding: 2px;
        }
        .slot.filled { border: 2px solid var(--cor-vinho); background: var(--cor-vinho); color: white; font-weight: bold; }

        /* BOT√ïES SABORES */
        .lista-sabores { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .btn-sabor { background: white; border: 1.5px solid var(--cor-vinho); color: var(--cor-vinho); padding: 12px; border-radius: 12px; cursor: pointer; font-weight: 500; }

        /* CARRINHO E FORMUL√ÅRIO */
        .item-carrinho { background: white; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--cor-vinho); position: relative; }
        .btn-remover { position: absolute; top: 10px; right: 10px; color: red; border: none; background: none; font-weight: bold; cursor: pointer; }
        
        .campo-grupo { margin-bottom: 15px; }
        .campo-grupo label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--cor-vinho); font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }

        .btn-add-carrinho { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; background: var(--cinza-inativo); color: white; margin-bottom: 20px; }
        .btn-add-carrinho.ativo { background: var(--cor-vinho); cursor: pointer; }

        .btn-whatsapp { width: 100%; background: var(--verde-wpp); color: white; padding: 16px; border-radius: 12px; font-weight: bold; border: none; font-size: 1.1rem; cursor: pointer; opacity: 0.5; pointer-events: none; }
        .btn-whatsapp.liberado { opacity: 1; pointer-events: auto; }

        /* ADMIN */
        .card-admin { background: #fff5f7; border: 1px solid var(--rosa-principal); padding: 15px; border-radius: 15px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>‚ù§Ô∏è Amor e Cacau</h1>
        <p class="subtitulo">Caixinha com 4 doces = R$ 10,00</p>
    </header>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="abrirAba(event, 'aba-combo')">Montar Pedido</button>
        <button class="tab-btn" onclick="abrirAba(event, 'aba-cardapio')">Card√°pio</button>
        <button class="tab-btn" style="background: #fdf2f5;" onclick="abrirAba(event, 'aba-admin')">üë©‚Äçüç≥ Produ√ß√£o</button>
    </div>

    <div id="aba-combo" class="tab-content active">
        <div class="box-display">
            <span id="contador-texto" style="font-weight: bold;">Monte sua caixinha (0/4):</span>
            <div class="slots-container" id="slots-area"></div>
            <p style="font-size:0.7rem; color:#888; margin-top:10px;">Toque no doce para remover</p>
        </div>

        <div class="lista-sabores" id="botoes-sabores"></div>

        <button id="btn-add-carrinho" class="btn-add-carrinho" onclick="adicionarAoCarrinho()">Preencha a caixa</button>

        <div id="carrinho-area" style="display:none; border-top: 2px dashed var(--cor-vinho); padding-top: 20px;">
            <h3 style="color: var(--cor-vinho)">üõí Seu Pedido</h3>
            <div id="lista-itens-carrinho"></div>
            
            <div class="campo-grupo">
                <label>Seu Nome:</label>
                <input type="text" id="nome-cliente" placeholder="Como te chamamos?" oninput="validarFinalizacao()">
            </div>

            <div class="campo-grupo">
                <label>Como deseja receber?</label>
                <select id="metodo-entrega" onchange="validarFinalizacao()">
                    <option value="">Selecione...</option>
                    <option value="Retirada">Vou retirar no local</option>
                    <option value="Uber Moto">Entrega via Uber Moto</option>
                </select>
            </div>

            <h2 id="total-carrinho" style="text-align:center; color: var(--cor-vinho);">Total: R$ 0,00</h2>
            <button id="btn-finalizar" class="btn-whatsapp" onclick="enviarTudo()">Finalizar no WhatsApp</button>
        </div>
    </div>

    <div id="aba-cardapio" class="tab-content">
        <div style="text-align: center; padding: 20px; border: 1px solid var(--bege-logo); border-radius: 20px; background: #fffcf9;">
            <h3 style="color: var(--cor-vinho)">Nossos Sabores</h3>
            <p>Tradicional ‚Ä¢ Caf√© ‚Ä¢ Lim√£o ‚Ä¢ Ferrero ‚Ä¢ Maracuj√° ‚Ä¢ Beijinho</p>
            <strong>R$ 3,00 a unidade</strong>
        </div>
    </div>

    <div id="aba-admin" class="tab-content">
        <div class="card-admin">
            <h3>üìä Resumo de Enrolagem</h3>
            <div id="resumo-producao">Aguardando...</div>
        </div>
        <h4>Pedidos Pendentes</h4>
        <div id="pedidos-lista-admin"></div>
    </div>
</div>

<script>
    // FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyDHcHj9p1CWXxJf14E9OIO1LJA4miwDGlo",
        authDomain: "amor-e-cacau.firebaseapp.com",
        projectId: "amor-e-cacau",
        storageBucket: "amor-e-cacau.firebasestorage.app",
        messagingSenderId: "766363119746",
        appId: "1:766363119746:web:1c63801fe2218ed224449b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const SABORES = ["Tradicional", "Beijinho", "Ferrero", "Lim√£o", "Caf√©", "Maracuj√°"];
    let caixaAtual = [];
    let carrinho = [];
    let autenticado = false;

    function abrirAba(e, id) {
        if (id === 'aba-admin' && !autenticado) {
            if (prompt("PIN:") === "1808") { autenticado = true; } else { return; }
        }
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        e.currentTarget.classList.add('active');
    }

    function renderizarBotoes() {
        const div = document.getElementById('botoes-sabores');
        div.innerHTML = SABORES.map(s => `
            <button class="btn-sabor" onclick="adicionarDoce('${s}')">+ ${s}</button>
        `).join('');
    }

    function adicionarDoce(s) {
        if(caixaAtual.length < 4) {
            caixaAtual.push(s);
            atualizarSlots();
        }
    }

    function atualizarSlots() {
        const area = document.getElementById('slots-area');
        area.innerHTML = '';
        for(let i=0; i<4; i++) {
            const slot = document.createElement('div');
            slot.className = caixaAtual[i] ? 'slot filled' : 'slot';
            slot.innerHTML = caixaAtual[i] ? `<span>${caixaAtual[i]}</span>` : '';
            slot.onclick = () => { if(caixaAtual[i]) { caixaAtual.splice(i, 1); atualizarSlots(); } };
            area.appendChild(slot);
        }
        const btn = document.getElementById('btn-add-carrinho');
        btn.disabled = caixaAtual.length !== 4;
        btn.className = btn.disabled ? 'btn-add-carrinho' : 'btn-add-carrinho ativo';
        btn.innerText = btn.disabled ? `Faltam ${4 - caixaAtual.length} doces` : "Adicionar Caixinha ao Pedido";
        document.getElementById('contador-texto').innerText = `Monte sua caixinha (${caixaAtual.length}/4):`;
    }

    function adicionarAoCarrinho() {
        carrinho.push([...caixaAtual]);
        caixaAtual = [];
        atualizarSlots();
        renderizarCarrinho();
        document.getElementById('carrinho-area').style.display = 'block';
    }

    function renderizarCarrinho() {
        const lista = document.getElementById('lista-itens-carrinho');
        lista.innerHTML = carrinho.map((caixa, i) => {
            const resumo = caixa.reduce((acc, s) => { acc[s] = (acc[s] || 0) + 1; return acc; }, {});
            const texto = Object.entries(resumo).map(([n, q]) => `${q}x ${n}`).join(', ');
            return `
                <div class="item-carrinho">
                    <strong>üì¶ Caixinha #${i+1}</strong><br>
                    <small>${texto}</small>
                    <button class="btn-remover" onclick="removerItem(${i})">Remover</button>
                </div>
            `;
        }).join('');
        document.getElementById('total-carrinho').innerText = `Total: R$ ${(carrinho.length * 10).toFixed(2).replace('.', ',')}`;
        validarFinalizacao();
    }

    function removerItem(i) { carrinho.splice(i, 1); renderizarCarrinho(); }

    function validarFinalizacao() {
        const nome = document.getElementById('nome-cliente').value;
        const entrega = document.getElementById('metodo-entrega').value;
        const btn = document.getElementById('btn-finalizar');
        btn.classList.toggle('liberado', nome.length > 2 && entrega !== "" && carrinho.length > 0);
    }

    async function enviarTudo() {
        const nome = document.getElementById('nome-cliente').value;
        const entrega = document.getElementById('metodo-entrega').value;
        
        try {
            // Salva no Firebase
            await db.collection("pedidos").add({
                cliente: nome, entrega: entrega, itens: carrinho.map(c => ({nome: "Caixa 4 Doces", sabores: c, preco: 10})),
                status: "pendente", data: new Date()
            });

            // Envia WhatsApp
            let msg = `*Amor e Cacau - NOVO PEDIDO*%0A*Cliente:* ${nome}%0A*Entrega:* ${entrega}%0A%0A`;
            carrinho.forEach((c, i) => {
                const resumo = c.reduce((acc, s) => { acc[s] = (acc[s] || 0) + 1; return acc; }, {});
                msg += `*Caixa ${i+1}:* ${Object.entries(resumo).map(([n, q]) => `${q}x ${n}`).join(', ')}%0A`;
            });
            msg += `%0A*Total: R$ ${(carrinho.length * 10).toFixed(2).replace('.', ',')}*`;
            
            window.open(`https://wa.me/5519992483488?text=${msg}`);
            
            carrinho = [];
            document.getElementById('nome-cliente').value = "";
            renderizarCarrinho();
            alert("Pedido enviado para produ√ß√£o!");
        } catch (e) { alert("Erro ao salvar."); }
    }

    // MONITOR DE PRODU√á√ÉO (ADMIN)
    db.collection("pedidos").where("status", "==", "pendente").onSnapshot((snapshot) => {
        let totais = {}; SABORES.forEach(s => totais[s] = 0);
        let html = "";
        snapshot.forEach(doc => {
            const p = doc.data();
            p.itens.forEach(it => it.sabores.forEach(s => totais[s]++));
            html += `
                <div class="item-carrinho">
                    <strong>${p.cliente}</strong> (${p.entrega})
                    <button class="btn-add-carrinho ativo" style="margin-top:10px" onclick="db.collection('pedidos').doc('${doc.id}').update({status:'ok'})">Concluir</button>
                </div>
            `;
        });
        document.getElementById('resumo-producao').innerHTML = SABORES.map(s => `
            <div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px dashed #ccc">
                <span>${s}</span> <strong>${totais[s]} un</strong>
            </div>
        `).join('');
        document.getElementById('pedidos-lista-admin').innerHTML = html || "Nenhum pedido pendente.";
    });

    renderizarBotoes();
    atualizarSlots();
</script>
</body>
</html>
