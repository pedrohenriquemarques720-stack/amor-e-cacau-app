<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amor e Cacau | Pedidos</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --cor-vinho: #800020;
            --rosa-principal: #ff85a2;
            --marrom-chocolate: #4b2e2e;
            --bege-logo: #f7ede2;
            --verde-wpp: #25d366;
            --cinza-inativo: #ccc;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bege-logo); color: var(--marrom-chocolate); margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        /* NAVEGA√á√ÉO */
        .tabs-nav { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; }
        .tab-btn { flex: none; padding: 10px 15px; border: none; background: #f0f0f0; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .tab-btn.active { background: var(--cor-vinho); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* CARD√ÅPIO */
        .cardapio-floral { text-align: center; padding: 20px; border: 2px solid var(--bege-logo); border-radius: 20px; background: #fffcf9; }
        .preco-lista { list-style: none; padding: 0; margin: 15px 0; border-top: 1px solid #eee; padding-top: 10px; }
        .preco-lista li { margin-bottom: 8px; font-weight: bold; }

        /* SLOTS E GRID */
        .box-display { background: #fffafa; padding: 15px; border-radius: 15px; margin-bottom: 20px; text-align: center; border: 1px solid #f0e0e0; }
        .slots-container { display: flex; justify-content: center; gap: 8px; margin-top: 10px; }
        .slot { width: 55px; height: 55px; border: 2px dashed var(--cor-vinho); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; background: white; cursor: pointer; text-align: center; }
        .slot.filled { border: 2px solid var(--cor-vinho); background: var(--cor-vinho); color: white; font-weight: bold; }
        
        .grid-botoes { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .btn-item { background: white; border: 1.5px solid var(--cor-vinho); color: var(--cor-vinho); padding: 12px; border-radius: 12px; cursor: pointer; font-weight: 500; }
        
        /* CONTROLES QUANTIDADE */
        .item-escala { display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #eee; border-radius: 15px; margin-bottom: 8px; }
        .btn-ctrl { background: var(--cor-vinho); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; }

        /* FINALIZA√á√ÉO */
        .area-finalizar { margin-top: 20px; padding: 15px; border-top: 2px dashed #eee; background: #fafafa; border-radius: 15px; }
        .btn-wpp { width: 100%; background: var(--verde-wpp); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 10px; opacity: 0.5; pointer-events: none; }
        .btn-wpp.liberado { opacity: 1; pointer-events: auto; }
        
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; }
        .card-admin { background: #fff5f7; border: 1px solid var(--rosa-principal); padding: 15px; border-radius: 15px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align: center; margin-bottom: 20px;">
        <h1 style="color: var(--cor-vinho); margin: 0;">‚ù§Ô∏è Amor e Cacau</h1>
    </header>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="abrirAba(event, 'aba-cardapio')">Card√°pio</button>
        <button class="tab-btn" onclick="abrirAba(event, 'aba-pronta')">Pronta Entrega</button>
        <button class="tab-btn" onclick="abrirAba(event, 'aba-combo')">Monte seu Combo</button>
        <button class="tab-btn" style="background: #fdf2f5;" onclick="abrirAba(event, 'aba-admin')">üë©‚Äçüç≥ Produ√ß√£o</button>
    </div>

    <div id="aba-cardapio" class="tab-content active">
        <div class="cardapio-floral">
            <h2 style="color: var(--cor-vinho)">Nossos Sabores</h2>
            <p>üç´ Tradicional ‚Ä¢ ü•• Beijinho ‚Ä¢ üå∞ Ferrero<br>üçã Lim√£o ‚Ä¢ ‚òï Caf√© ‚Ä¢ üü° Maracuj√°</p>
            
            <ul class="preco-lista">
                <li>1 Unidade: R$ 3,00</li>
                <li>üì¶ Caixinha (4 un): R$ 10,00</li>
                <li>üéâ 25 Doces: R$ 50,00</li>
                <li>üéâ 50 Doces: R$ 70,00</li>
                <li>üéâ 75 Doces: R$ 100,00</li>
                <li>üéâ 100 Doces: R$ 120,00</li>
            </ul>
        </div>
    </div>

    <div id="aba-pronta" class="tab-content">
        <h3 style="color: var(--cor-vinho)">üéâ Encomenda de Centos</h3>
        <p style="font-size: 0.8rem; margin-bottom: 15px;">Escolha as partes de 25 unidades (m√°x 4 partes):</p>
        <div id="lista-escala-cento"></div>
        <h3 id="total-cento-texto" style="text-align: center; color: var(--cor-vinho);">Total: R$ 0,00</h3>
        
        <div class="area-finalizar">
            <input type="text" id="nome-pronta" placeholder="Seu Nome" oninput="validar('pronta')">
            <select id="entrega-pronta" onchange="validar('pronta')">
                <option value="">Como vai receber?</option>
                <option value="Retirada">Retirada</option>
                <option value="Uber Moto">Uber Moto</option>
            </select>
            <button id="btn-pronta" class="btn-wpp" onclick="finalizar('pronta')">Pedir no WhatsApp</button>
        </div>
    </div>

    <div id="aba-combo" class="tab-content">
        <div class="box-display">
            <span id="contador-texto" style="font-weight: bold;">Monte sua caixinha (0/4):</span>
            <div class="slots-container" id="slots-area"></div>
            <p style="font-size:0.7rem; color:#888; margin-top:10px;">Toque no doce para remover</p>
        </div>
        <div class="grid-botoes" id="botoes-sabores"></div>

        <div class="area-finalizar">
            <input type="text" id="nome-combo" placeholder="Seu Nome" oninput="validar('combo')">
            <select id="entrega-combo" onchange="validar('combo')">
                <option value="">Como vai receber?</option>
                <option value="Retirada">Retirada</option>
                <option value="Uber Moto">Uber Moto</option>
            </select>
            <button id="btn-combo" class="btn-wpp" onclick="finalizar('combo')">Pedir Caixinha (R$ 10,00)</button>
        </div>
    </div>

    <div id="aba-admin" class="tab-content">
        <div class="card-admin">
            <h3>üìä Resumo para Enrolar</h3>
            <div id="resumo-producao">...</div>
        </div>
        <div id="pedidos-lista-admin"></div>
    </div>
</div>

<script>
    // FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyDHcHj9p1CWXxJf14E9OIO1LJA4miwDGlo",
        authDomain: "amor-e-cacau.firebaseapp.com",
        projectId: "amor-e-cacau",
        storageBucket: "amor-e-cacau.firebasestorage.app",
        messagingSenderId: "766363119746",
        appId: "1:766363119746:web:1c63801fe2218ed224449b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const SABORES = ["Tradicional", "Beijinho", "Ferrero", "Lim√£o", "Caf√©", "Maracuj√°"];
    let caixaAtual = []; // Para a aba Combo
    let escalaCento = {}; SABORES.forEach(s => escalaCento[s] = 0); // Para a aba Pronta Entrega
    let autenticado = false;

    function abrirAba(e, id) {
        if (id === 'aba-admin' && !autenticado) {
            if (prompt("PIN:") === "1808") { autenticado = true; } else { return; }
        }
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        e.currentTarget.classList.add('active');
    }

    // --- LOGICA PRONTA ENTREGA (CENTO) ---
    function renderEscala() {
        const totalPartes = Object.values(escalaCento).reduce((a, b) => a + b, 0);
        const precos = { 0:0, 1: 50, 2: 70, 3: 100, 4: 120 };
        
        document.getElementById('lista-escala-cento').innerHTML = SABORES.map(s => `
            <div class="item-escala">
                <span><strong>25x ${s}</strong></span>
                <div>
                    <button class="btn-ctrl" onclick="mudarEscala('${s}', -1)">-</button>
                    <span style="margin: 0 10px; font-weight: bold;">${escalaCento[s]}</span>
                    <button class="btn-ctrl" onclick="mudarEscala('${s}', 1)" ${totalPartes >= 4 ? 'disabled' : ''}>+</button>
                </div>
            </div>
        `).join('');
        
        document.getElementById('total-cento-texto').innerText = `Total: R$ ${precos[totalPartes]},00`;
        validar('pronta');
    }

    function mudarEscala(s, d) {
        if (!(d === -1 && escalaCento[s] === 0)) {
            escalaCento[s] += d;
            renderEscala();
        }
    }

    // --- LOGICA MONTE SEU COMBO (SLOTS) ---
    function renderBotoes() {
        document.getElementById('botoes-sabores').innerHTML = SABORES.map(s => `
            <button class="btn-item" onclick="addDoce('${s}')">+ ${s}</button>
        `).join('');
    }

    function addDoce(s) {
        if(caixaAtual.length < 4) {
            caixaAtual.push(s);
            atualizarSlots();
        }
    }

    function atualizarSlots() {
        const area = document.getElementById('slots-area');
        area.innerHTML = '';
        for(let i=0; i<4; i++) {
            const slot = document.createElement('div');
            slot.className = caixaAtual[i] ? 'slot filled' : 'slot';
            slot.innerHTML = caixaAtual[i] ? `<span>${caixaAtual[i]}</span>` : '';
            slot.onclick = () => { if(caixaAtual[i]) { caixaAtual.splice(i, 1); atualizarSlots(); } };
            area.appendChild(slot);
        }
        document.getElementById('contador-texto').innerText = `Monte sua caixinha (${caixaAtual.length}/4):`;
        validar('combo');
    }

    // --- VALIDA√á√ÉO E FINALIZA√á√ÉO ---
    function validar(tipo) {
        const nome = document.getElementById(`nome-${tipo}`).value;
        const entrega = document.getElementById(`entrega-${tipo}`).value;
        const btn = document.getElementById(`btn-${tipo}`);
        
        let pronto = (nome.trim().length > 2 && entrega !== "");
        if(tipo === 'pronta') {
            const totalP = Object.values(escalaCento).reduce((a, b) => a + b, 0);
            pronto = pronto && totalP > 0;
        } else {
            pronto = pronto && caixaAtual.length === 4;
        }
        
        btn.classList.toggle('liberado', pronto);
    }

    async function finalizar(tipo) {
        const nome = document.getElementById(`nome-${tipo}`).value;
        const entrega = document.getElementById(`entrega-${tipo}`).value;
        let itemNome = "";
        let saboresPedido = [];
        let precoFinal = 0;

        if(tipo === 'pronta') {
            const totalP = Object.values(escalaCento).reduce((a, b) => a + b, 0);
            const precos = { 1: 50, 2: 70, 3: 100, 4: 120 };
            precoFinal = precos[totalP];
            itemNome = `Combo ${totalP * 25} Doces`;
            for(let s in escalaCento) {
                for(let i=0; i < escalaCento[s] * 25; i++) saboresPedido.push(s);
            }
        } else {
            precoFinal = 10;
            itemNome = "Caixinha 4 Doces";
            saboresPedido = [...caixaAtual];
        }

        try {
            await db.collection("pedidos").add({
                cliente: nome, entrega: entrega, itens: [{nome: itemNome, sabores: saboresPedido, preco: precoFinal}],
                status: "pendente", data: new Date()
            });

            let msg = `*Amor e Cacau - NOVO PEDIDO*%0A*Nome:* ${nome}%0A*Entrega:* ${entrega}%0A*Item:* ${itemNome}%0A%0A*Resumo:* `;
            if(tipo === 'pronta') {
                for(let s in escalaCento) if(escalaCento[s] > 0) msg += `%0A- ${escalaCento[s] * 25}x ${s}`;
            } else {
                msg += saboresPedido.join(', ');
            }
            msg += `%0A%0A*Total: R$ ${precoFinal},00*`;

            window.open(`https://wa.me/5519992483488?text=${msg}`);
            location.reload(); // Recarrega para limpar
        } catch (e) { alert("Erro ao salvar."); }
    }

    // --- PRODU√á√ÉO ---
    db.collection("pedidos").where("status", "==", "pendente").onSnapshot(snap => {
        let totais = {}; SABORES.forEach(s => totais[s] = 0);
        let html = "";
        snap.forEach(doc => {
            const p = doc.data();
            p.itens[0].sabores.forEach(s => totais[s]++);
            html += `<div class="card-admin"><strong>${p.cliente}</strong> (${p.entrega})<br><small>${p.itens[0].nome}</small><br><button class="btn-item" style="width:100%; margin-top:10px" onclick="db.collection('pedidos').doc('${doc.id}').update({status:'ok'})">Concluir</button></div>`;
        });
        document.getElementById('resumo-producao').innerHTML = SABORES.map(s => `<div>${s}: <strong>${totais[s]}</strong></div>`).join('');
        document.getElementById('pedidos-lista-admin').innerHTML = html;
    });

    renderEscala();
    renderBotoes();
    atualizarSlots();
</script>
</body>
</html>
